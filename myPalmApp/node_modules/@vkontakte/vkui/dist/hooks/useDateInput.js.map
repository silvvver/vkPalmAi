{"version":3,"sources":["../../src/hooks/useDateInput.ts"],"sourcesContent":["import { useCallback } from 'react';\nimport * as React from 'react';\nimport { useDOM } from '../lib/dom';\nimport { useBooleanState } from './useBooleanState';\nimport { useGlobalEventListener } from './useGlobalEventListener';\n\nexport interface UseDateInputDependencies<T, D> {\n  maxElement: number;\n  refs: Array<React.RefObject<T | null>>;\n  autoFocus?: boolean;\n  disabled?: boolean;\n  value?: D | null;\n  elementsConfig: (index: number) => {\n    length: number;\n    min: number;\n    max: number;\n  };\n  onInternalValueChange: (value: string[]) => void;\n  getInternalValue: (value?: D | null | undefined) => string[];\n  onClear: () => void;\n  onCalendarOpenChanged?: (opened: boolean) => void;\n  accessible?: boolean;\n}\n\nexport function useDateInput<T extends HTMLElement, D>({\n  maxElement,\n  refs,\n  autoFocus,\n  disabled,\n  elementsConfig,\n  onClear,\n  onInternalValueChange,\n  getInternalValue,\n  value,\n  onCalendarOpenChanged,\n  accessible,\n}: UseDateInputDependencies<T, D>): {\n  rootRef: React.RefObject<HTMLDivElement | null>;\n  calendarRef: React.RefObject<HTMLDivElement | null>;\n  open: boolean;\n  openCalendar: () => void;\n  closeCalendar: () => void;\n  toggleCalendar: () => void;\n  internalValue: string[];\n  focusedElement: number | null;\n  setFocusedElement: React.Dispatch<React.SetStateAction<number | null>>;\n  handleKeyDown: (e: React.KeyboardEvent<HTMLSpanElement>) => void;\n  clear: () => void;\n  handleFieldEnter: () => void;\n  removeFocusFromField: () => void;\n  handleRestoreFocus: () => boolean;\n} {\n  const { document } = useDOM();\n  const { value: open, setTrue: openCalendar, setFalse: closeCalendar } = useBooleanState(false);\n  const rootRef = React.useRef<HTMLDivElement | null>(null);\n  const calendarRef = React.useRef<HTMLDivElement | null>(null);\n  const [internalValue, setInternalValue] = React.useState<string[]>([]);\n  const [focusedElement, setFocusedElement] = React.useState<number | null>(null);\n  const isClickedOutsideRef = React.useRef(false);\n  const { window } = useDOM();\n\n  const handleRestoreFocus = React.useCallback(() => {\n    // если календарь был закрыт кликом вне календаря\n    // то FocusTrap возвращать фокус не должен\n    return !isClickedOutsideRef.current;\n  }, []);\n\n  const _onCalendarClose = useCallback(() => {\n    if (open) {\n      closeCalendar();\n      onCalendarOpenChanged?.(false);\n    }\n  }, [closeCalendar, onCalendarOpenChanged, open]);\n\n  const _onCalendarOpen = useCallback(() => {\n    if (!open) {\n      openCalendar();\n      onCalendarOpenChanged?.(true);\n      if (accessible) {\n        setFocusedElement(null);\n      }\n      isClickedOutsideRef.current = false;\n    }\n  }, [onCalendarOpenChanged, open, openCalendar, accessible]);\n\n  const toggleCalendar = useCallback(() => {\n    if (open) {\n      _onCalendarClose();\n    } else {\n      _onCalendarOpen();\n    }\n  }, [open, _onCalendarOpen, _onCalendarClose]);\n\n  const removeFocusFromField = React.useCallback(() => {\n    if (focusedElement !== null) {\n      setFocusedElement(null);\n      window!.getSelection()?.removeAllRanges();\n      setInternalValue(getInternalValue(value));\n    }\n    _onCalendarClose();\n  }, [_onCalendarClose, window, getInternalValue, value, focusedElement]);\n\n  const handleClickOutside = React.useCallback(\n    (e: MouseEvent) => {\n      if (\n        !rootRef.current?.contains(e.target as Node | null) &&\n        !calendarRef.current?.contains(e.target as Node | null)\n      ) {\n        isClickedOutsideRef.current = true;\n        removeFocusFromField();\n      }\n    },\n    [removeFocusFromField],\n  );\n\n  const selectFirst = React.useCallback(() => {\n    if (focusedElement !== null) {\n      return;\n    }\n\n    setFocusedElement(0);\n  }, [focusedElement]);\n\n  useGlobalEventListener(document, 'click', handleClickOutside, {\n    capture: true,\n  });\n\n  React.useEffect(() => {\n    setInternalValue(getInternalValue(value));\n  }, [getInternalValue, value]);\n\n  React.useEffect(() => {\n    if (autoFocus) {\n      selectFirst();\n    }\n  }, [autoFocus, selectFirst]);\n\n  React.useEffect(() => {\n    if (disabled || focusedElement === null) {\n      return;\n    }\n\n    const range = window!.document.createRange();\n\n    let element = refs[focusedElement].current;\n\n    let timerId: ReturnType<typeof setTimeout>;\n    if (element) {\n      element.focus();\n      if (!accessible) {\n        _onCalendarOpen();\n      }\n      range.selectNodeContents(element as Node);\n\n      // Fix для Firefox: setTimeout нужен чтобы отложить range selection на\n      // какое-то время, иначе, при фокусе на InputLike\n      // извне, контент визуально не будет выбран\n      timerId = setTimeout(() => {\n        const selection = window!.getSelection();\n        selection?.removeAllRanges();\n        selection?.addRange(range);\n      }, 0);\n    }\n\n    return () => {\n      clearTimeout(timerId);\n    };\n  }, [disabled, focusedElement, refs, window, _onCalendarOpen, accessible]);\n\n  const clear = React.useCallback(() => {\n    onClear?.();\n    selectFirst();\n  }, [onClear, selectFirst]);\n\n  const handleFieldEnter = React.useCallback(() => {\n    selectFirst();\n  }, [selectFirst]);\n\n  const handleKeyDown = React.useCallback(\n    (e: React.KeyboardEvent<HTMLSpanElement>) => {\n      if (focusedElement === null) {\n        return;\n      }\n\n      const _value = [...internalValue];\n      const config = elementsConfig(focusedElement);\n\n      if (/^\\d+$/.test(e.key)) {\n        if (_value[focusedElement].length >= config.length) {\n          _value[focusedElement] = e.key;\n        } else {\n          _value[focusedElement] += e.key;\n          if (_value[focusedElement].length >= config.length && focusedElement < maxElement) {\n            setFocusedElement(focusedElement + 1);\n          }\n        }\n      } else if (e.key === 'Backspace') {\n        if (!_value[focusedElement]) {\n          setFocusedElement(focusedElement <= 0 ? maxElement : focusedElement - 1);\n        } else {\n          _value[focusedElement] = _value[focusedElement].slice(0, -1);\n        }\n      } else if (e.key === 'ArrowDown' || e.key === 'Down') {\n        let currentValue = Number(_value[focusedElement]);\n        _value[focusedElement] = String(\n          currentValue <= config.min ? config.max : currentValue - 1,\n        ).padStart(config.length, '0');\n      } else if (e.key === 'ArrowUp' || e.key === 'Up') {\n        let currentValue = Number(_value[focusedElement]);\n        _value[focusedElement] = String(\n          currentValue >= config.max ? config.min : currentValue + 1,\n        ).padStart(config.length, '0');\n      } else if (e.key === 'ArrowLeft' || e.key === 'Left' || (e.key === 'Tab' && e.shiftKey)) {\n        if (focusedElement <= 0) {\n          removeFocusFromField();\n          return;\n        }\n        setFocusedElement(focusedElement - 1);\n      } else if (e.key === 'ArrowRight' || e.key === 'Right' || e.key === 'Tab') {\n        if (focusedElement >= maxElement) {\n          removeFocusFromField();\n          return;\n        }\n\n        setFocusedElement(focusedElement + 1);\n      } else if (e.key === 'Delete' || e.key === 'Del') {\n        _value[focusedElement] = '';\n      } else if (e.key === ' ') {\n        e.preventDefault();\n        _onCalendarOpen();\n        return;\n      } else {\n        return;\n      }\n\n      e.preventDefault();\n      setInternalValue(_value);\n      onInternalValueChange(_value);\n    },\n    [\n      _onCalendarOpen,\n      removeFocusFromField,\n      elementsConfig,\n      focusedElement,\n      internalValue,\n      maxElement,\n      onInternalValueChange,\n    ],\n  );\n\n  return {\n    rootRef,\n    calendarRef,\n    open,\n    openCalendar: _onCalendarOpen,\n    closeCalendar: _onCalendarClose,\n    toggleCalendar,\n    internalValue,\n    focusedElement,\n    setFocusedElement,\n    handleKeyDown,\n    clear,\n    handleFieldEnter,\n    removeFocusFromField,\n    handleRestoreFocus,\n  };\n}\n"],"names":["useCallback","React","useDOM","useBooleanState","useGlobalEventListener","useDateInput","maxElement","refs","autoFocus","disabled","elementsConfig","onClear","onInternalValueChange","getInternalValue","value","onCalendarOpenChanged","accessible","document","open","setTrue","openCalendar","setFalse","closeCalendar","rootRef","useRef","calendarRef","internalValue","setInternalValue","useState","focusedElement","setFocusedElement","isClickedOutsideRef","window","handleRestoreFocus","current","_onCalendarClose","_onCalendarOpen","toggleCalendar","removeFocusFromField","getSelection","removeAllRanges","handleClickOutside","e","contains","target","selectFirst","capture","useEffect","range","createRange","element","timerId","focus","selectNodeContents","setTimeout","selection","addRange","clearTimeout","clear","handleFieldEnter","handleKeyDown","_value","config","test","key","length","slice","currentValue","Number","String","min","max","padStart","shiftKey","preventDefault"],"mappings":"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"}