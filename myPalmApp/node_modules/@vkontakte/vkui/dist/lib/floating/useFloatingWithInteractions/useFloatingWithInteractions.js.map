{"version":3,"sources":["../../../../src/lib/floating/useFloatingWithInteractions/useFloatingWithInteractions.ts"],"sourcesContent":["import * as React from 'react';\nimport { debounce, noop } from '@vkontakte/vkjs';\nimport { getWindow, isHTMLElement } from '@vkontakte/vkui-floating-ui/utils/dom';\nimport { useCustomEnsuredControl } from '../../../hooks/useEnsuredControl';\nimport { useGlobalOnClickOutside } from '../../../hooks/useGlobalOnClickOutside';\nimport { useStableCallback } from '../../../hooks/useStableCallback';\nimport { contains, getActiveElementByAnotherElement } from '../../dom';\nimport { useIsomorphicLayoutEffect } from '../../useIsomorphicLayoutEffect';\nimport { autoUpdateFloatingElement, useFloating } from '../adapters';\nimport { convertFloatingDataToReactCSSProperties } from '../functions';\nimport { type UseFloatingOptions } from '../types/common';\nimport { DEFAULT_TRIGGER } from './constants';\nimport type {\n  FloatingProps,\n  ReferenceProps,\n  ShownChangeReason,\n  UseFloatingWithInteractionsProps,\n  UseFloatingWithInteractionsReturn,\n} from './types';\nimport { useResolveTriggerType } from './useResolveTriggerType';\n\ntype LocalState = { shown: boolean; reason?: ShownChangeReason };\n\nconst whileElementsMounted: UseFloatingOptions['whileElementsMounted'] = (...args) =>\n  /* istanbul ignore next: не знаю как проверить */\n  autoUpdateFloatingElement(...args, { elementResize: true });\n\n/**\n * @private\n */\nexport const useFloatingWithInteractions = <T extends HTMLElement = HTMLElement>({\n  trigger = DEFAULT_TRIGGER,\n\n  // UseFloating\n  placement: placementProp = 'bottom',\n  strategy: strategyProp = 'fixed',\n  middlewares,\n  hoverDelay = 0,\n  closeAfterClick = false,\n\n  // disables\n  disabled = false,\n  disableInteractive = false,\n  disableCloseOnClickOutside = false,\n  disableCloseOnEscKey = false,\n\n  // uncontrolled\n  defaultShown = false,\n\n  // controlled\n  shown: shownProp,\n  onShownChange: onShownChangeProp,\n  onShownChanged: onShownChangedProp,\n}: UseFloatingWithInteractionsProps): UseFloatingWithInteractionsReturn<T> => {\n  const memoizedValue = React.useMemo<LocalState | undefined>(\n    () => (shownProp !== undefined ? { shown: shownProp } : undefined),\n    [shownProp],\n  );\n  const [shownLocalState, setShownLocalState] = useCustomEnsuredControl<LocalState>({\n    value: memoizedValue,\n    disabled,\n    defaultValue: { shown: defaultShown },\n    onChange: useStableCallback(({ shown, reason }) => {\n      if (onShownChangeProp) {\n        onShownChangeProp(shown, reason);\n      }\n    }),\n  });\n  const onShownChanged = useStableCallback(onShownChangedProp ? onShownChangedProp : noop);\n  const [shownFinalState, setShownFinalState] = React.useState(() => shownLocalState.shown);\n  const [willBeHide, setWillBeHide] = React.useState(false);\n\n  const hasCSSAnimation = React.useRef(false);\n\n  const blockMouseEnterRef = React.useRef(false);\n  const blockFocusRef = React.useRef(false);\n  const blurTimeoutRef = React.useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n\n  const handleCloseOnReferenceClickOutsideDisabled =\n    disabled || disableCloseOnClickOutside || willBeHide || !shownLocalState.shown;\n  const handleCloseOnFloatingClickOutsideDisabled =\n    disableInteractive || handleCloseOnReferenceClickOutsideDisabled;\n\n  const { triggerOnFocus, triggerOnClick, triggerOnHover } = useResolveTriggerType(trigger);\n\n  // Библиотека `floating-ui`\n  const { placement, x, y, strategy, refs, middlewareData } = useFloating<T>({\n    strategy: strategyProp,\n    placement: placementProp,\n    middleware: middlewares,\n    whileElementsMounted,\n  });\n\n  const commitShownLocalState = React.useCallback(\n    (nextShown: boolean, reason: ShownChangeReason) => {\n      setShownLocalState((prevState) => {\n        if (prevState.shown !== nextShown || prevState.reason !== reason) {\n          return {\n            shown: nextShown,\n            reason,\n          };\n        }\n        /* istanbul ignore next: страховка, если вдруг на момент вызова обновления состояния, оно уже будет актуальным */\n        return prevState;\n      });\n    },\n    [setShownLocalState],\n  );\n\n  const [mouseEnterDelay, mouseLeaveDelay] =\n    typeof hoverDelay === 'number' ? [hoverDelay, hoverDelay] : hoverDelay;\n\n  const showWithDelay = React.useMemo(\n    () => debounce(() => commitShownLocalState(true, 'hover'), mouseEnterDelay),\n    [mouseEnterDelay, commitShownLocalState],\n  );\n\n  const hideWithDelay = React.useMemo(\n    () => debounce(() => commitShownLocalState(false, 'hover'), mouseLeaveDelay),\n    [mouseLeaveDelay, commitShownLocalState],\n  );\n\n  const handleFocusOnReference = useStableCallback(() => {\n    // Повторный вызов события фокуса - следствие клика на reference-элемент\n    if (shownLocalState.shown) {\n      if (!closeAfterClick && shownLocalState.reason === 'hover') {\n        return;\n      }\n      commitShownLocalState(false, 'focus');\n      return;\n    }\n    if (blockFocusRef.current) {\n      /* istanbul ignore next: в Jest не воспроизводится баг на вебе (cм. onRestoreFocus) */\n      blockFocusRef.current = false;\n      return;\n    }\n\n    commitShownLocalState(true, 'focus');\n  });\n\n  const handleBlurOnReference = useStableCallback((event: React.FocusEvent) => {\n    blockFocusRef.current = false;\n    blockMouseEnterRef.current = false;\n\n    if (!shownLocalState.shown) {\n      clearTimeout(blurTimeoutRef.current);\n      return;\n    }\n\n    const relatedTarget = event.relatedTarget;\n    blurTimeoutRef.current = setTimeout(function waitWindowBlurFire() {\n      const reference = refs.reference.current;\n      // Если пользователь покинул текущее окно в открытом состоянии, то\n      // не закрываем всплывающий элемент.\n      /* istanbul ignore if: не умеем симулировать уход из текущего окна */\n      if (!relatedTarget && getActiveElementByAnotherElement(reference) === reference) {\n        /* istanbul ignore next */\n        return;\n      }\n\n      // Если пользователь нажал на всплывающий элемент, то не закрываем всплывающий элемент.\n      // Note: для этого элемент должен быть фокусируемый (например, за счёт `tabindex=\"-1\"`).\n      if (contains(refs.floating.current, relatedTarget) || contains(reference, relatedTarget)) {\n        return;\n      }\n\n      commitShownLocalState(false, 'focus');\n    });\n  });\n\n  const handleClickOnReference = useStableCallback(() => {\n    // Предыдущий триггер (фокус) уже вызвал открытие/закрытие всплывающего окна, игнорируем вызов\n    if (shownLocalState.reason === 'focus') {\n      commitShownLocalState(shownLocalState.shown, 'click');\n      return;\n    }\n    commitShownLocalState(!shownLocalState.shown, 'click');\n  });\n\n  const handleClickOnReferenceForOnlyClose = useStableCallback(() => {\n    blockMouseEnterRef.current = true;\n    commitShownLocalState(false, 'click');\n  });\n\n  const handleMouseEnterOnBoth = useStableCallback((event: React.MouseEvent<HTMLElement>) => {\n    if (willBeHide && event.currentTarget === refs.floating.current) {\n      return;\n    }\n\n    showWithDelay.cancel();\n    hideWithDelay.cancel();\n\n    if (!blockMouseEnterRef.current && !shownLocalState.shown) {\n      showWithDelay();\n    }\n  });\n\n  const handleMouseLeaveOnBothForHoverAndFocusStates = useStableCallback(\n    (event: React.MouseEvent<HTMLElement>) => {\n      if (willBeHide && event.currentTarget === refs.floating.current) {\n        return;\n      }\n\n      blockFocusRef.current = false;\n      blockMouseEnterRef.current = false;\n\n      if (triggerOnHover) {\n        showWithDelay.cancel();\n        hideWithDelay.cancel();\n\n        hideWithDelay();\n      }\n    },\n  );\n\n  const handleFloatingAnimationStart = () => {\n    hasCSSAnimation.current = true;\n  };\n\n  const handleFloatingAnimationEnd = () => {\n    if (willBeHide) {\n      setShownFinalState(false);\n      setWillBeHide(false);\n      onShownChanged(false, shownLocalState.reason);\n    }\n  };\n\n  const handleOnClose = React.useCallback(() => {\n    blockFocusRef.current = true;\n    commitShownLocalState(false, 'callback');\n  }, [commitShownLocalState]);\n\n  const handleRestoreFocus: UseFloatingWithInteractionsReturn['onRestoreFocus'] = React.useCallback(\n    (restoreFocus = true) => {\n      if (!restoreFocus) {\n        return false;\n      }\n      if (restoreFocus === true) {\n        return triggerOnFocus ? blockFocusRef.current : true;\n      } else if (restoreFocus === 'anchor-element') {\n        return refs.reference.current as HTMLElement;\n      } else if (restoreFocus instanceof HTMLElement) {\n        return restoreFocus;\n      }\n      return false;\n    },\n    [refs.reference, triggerOnFocus],\n  );\n\n  const handleEscapeKeyDown = React.useCallback(() => {\n    blockFocusRef.current = true;\n    commitShownLocalState(false, 'escape-key');\n  }, [commitShownLocalState]);\n\n  const handleClickOutside = React.useCallback(() => {\n    blockFocusRef.current = true;\n    commitShownLocalState(false, 'click-outside');\n  }, [commitShownLocalState]);\n\n  useGlobalOnClickOutside(\n    handleClickOutside,\n    handleCloseOnReferenceClickOutsideDisabled ? null : refs.reference,\n    handleCloseOnFloatingClickOutsideDisabled ? null : refs.floating,\n  );\n\n  useIsomorphicLayoutEffect(\n    /**\n     * Если пользователь покинул активное окно и:\n     * 1. целевой элемент был в состоянии фокуса;\n     * 2. всплывающий элемент был закрытом состоянии;\n     * то фокус должен быть заблокирован, когда пользователь вернётся обратно. Иначе покажется\n     * всплывающий элемент.\n     */\n    function setGlobalBlurForTriggerOnFocus() {\n      if (!triggerOnFocus || !refs.reference.current) {\n        return;\n      }\n\n      const handleGlobalBlur = () => {\n        /* istanbul ignore next */\n        const reference = refs.reference.current;\n        /* istanbul ignore if: не умеем симулировать уход из текущего окна */\n        if (\n          !shownLocalState.shown &&\n          isHTMLElement(reference) &&\n          reference === getActiveElementByAnotherElement(reference)\n        ) {\n          /* istanbul ignore next */\n          blockFocusRef.current = true;\n        }\n      };\n\n      const win = getWindow(refs.reference.current);\n      win.addEventListener('blur', handleGlobalBlur);\n      return () => {\n        win.removeEventListener('blur', handleGlobalBlur);\n      };\n    },\n    [triggerOnFocus, refs.reference, shownLocalState],\n  );\n\n  useIsomorphicLayoutEffect(\n    function resolveShownStates() {\n      if (willBeHide || shownLocalState.shown === shownFinalState) {\n        return;\n      }\n\n      if (shownLocalState.shown) {\n        setShownFinalState(true);\n        onShownChanged(true, shownLocalState.reason);\n      } else if (hasCSSAnimation.current && !willBeHide) {\n        setWillBeHide(true);\n      } else {\n        setShownFinalState(false);\n      }\n\n      return () => {\n        clearTimeout(blurTimeoutRef.current);\n      };\n    },\n    [shownLocalState, shownFinalState, willBeHide, onShownChanged],\n  );\n\n  const referencePropsRef = React.useRef<ReferenceProps>({});\n  const floatingPropsRef = React.useRef<FloatingProps>({ style: {} });\n\n  useIsomorphicLayoutEffect(() => {\n    referencePropsRef.current = {};\n  }, [triggerOnHover, triggerOnFocus, triggerOnClick]);\n\n  if (shownFinalState) {\n    floatingPropsRef.current.style = convertFloatingDataToReactCSSProperties({\n      strategy,\n      x,\n      y,\n      middlewareData,\n    });\n\n    if (disableInteractive) {\n      floatingPropsRef.current.style.pointerEvents = 'none';\n    }\n  }\n\n  if (triggerOnFocus) {\n    referencePropsRef.current.onFocus = handleFocusOnReference;\n    referencePropsRef.current.onBlur = handleBlurOnReference;\n  }\n\n  if (triggerOnClick) {\n    referencePropsRef.current.onClick = handleClickOnReference;\n  }\n\n  if (triggerOnHover) {\n    referencePropsRef.current.onMouseOver = handleMouseEnterOnBoth;\n\n    if (closeAfterClick && !triggerOnClick) {\n      referencePropsRef.current.onClick = handleClickOnReferenceForOnlyClose;\n    }\n\n    if (!disableInteractive) {\n      floatingPropsRef.current.onMouseOver = handleMouseEnterOnBoth;\n    }\n  }\n\n  if (triggerOnHover || triggerOnFocus) {\n    referencePropsRef.current.onMouseLeave = handleMouseLeaveOnBothForHoverAndFocusStates;\n\n    if (!disableInteractive) {\n      floatingPropsRef.current.onMouseLeave = handleMouseLeaveOnBothForHoverAndFocusStates;\n    }\n  }\n\n  if (shownFinalState) {\n    floatingPropsRef.current.onAnimationStart = handleFloatingAnimationStart;\n    floatingPropsRef.current.onAnimationEnd = handleFloatingAnimationEnd;\n  }\n\n  return {\n    placement,\n    shown: shownFinalState,\n    willBeHide,\n    refs,\n    referenceProps: referencePropsRef.current,\n    floatingProps: floatingPropsRef.current,\n    middlewareData,\n    onClose: handleOnClose,\n    // FocusTrap уже определяет нажатие на ESC, поэтому название события содержит конкретный код\n    // кнопки вместо просто onKeyDown.\n    onEscapeKeyDown: !shownFinalState || disableCloseOnEscKey ? undefined : handleEscapeKeyDown,\n    // [Обход баги с FocusTrap]\n    //\n    // Если сфокусироваться на целевой элемент через нажатие, а потом нажать в область за пределами\n    // целевого и всплывающего элемента, то появляется моргание из-за того, что FocusTrap\n    // восстанавливает фокус, из-за чего всплывающий элемент снова показывается за счёт\n    // `handleFocusOnReference`, а потом скрывается за счёт `handleBlurOnReference`.\n    onRestoreFocus: handleRestoreFocus,\n  };\n};\n"],"names":["React","debounce","noop","getWindow","isHTMLElement","useCustomEnsuredControl","useGlobalOnClickOutside","useStableCallback","contains","getActiveElementByAnotherElement","useIsomorphicLayoutEffect","autoUpdateFloatingElement","useFloating","convertFloatingDataToReactCSSProperties","DEFAULT_TRIGGER","useResolveTriggerType","whileElementsMounted","args","elementResize","useFloatingWithInteractions","trigger","placement","placementProp","strategy","strategyProp","middlewares","hoverDelay","closeAfterClick","disabled","disableInteractive","disableCloseOnClickOutside","disableCloseOnEscKey","defaultShown","shown","shownProp","onShownChange","onShownChangeProp","onShownChanged","onShownChangedProp","memoizedValue","useMemo","undefined","shownLocalState","setShownLocalState","value","defaultValue","onChange","reason","shownFinalState","setShownFinalState","useState","willBeHide","setWillBeHide","hasCSSAnimation","useRef","blockMouseEnterRef","blockFocusRef","blurTimeoutRef","handleCloseOnReferenceClickOutsideDisabled","handleCloseOnFloatingClickOutsideDisabled","triggerOnFocus","triggerOnClick","triggerOnHover","x","y","refs","middlewareData","middleware","commitShownLocalState","useCallback","nextShown","prevState","mouseEnterDelay","mouseLeaveDelay","showWithDelay","hideWithDelay","handleFocusOnReference","current","handleBlurOnReference","event","clearTimeout","relatedTarget","setTimeout","waitWindowBlurFire","reference","floating","handleClickOnReference","handleClickOnReferenceForOnlyClose","handleMouseEnterOnBoth","currentTarget","cancel","handleMouseLeaveOnBothForHoverAndFocusStates","handleFloatingAnimationStart","handleFloatingAnimationEnd","handleOnClose","handleRestoreFocus","restoreFocus","HTMLElement","handleEscapeKeyDown","handleClickOutside","setGlobalBlurForTriggerOnFocus","handleGlobalBlur","win","addEventListener","removeEventListener","resolveShownStates","referencePropsRef","floatingPropsRef","style","pointerEvents","onFocus","onBlur","onClick","onMouseOver","onMouseLeave","onAnimationStart","onAnimationEnd","referenceProps","floatingProps","onClose","onEscapeKeyDown","onRestoreFocus"],"mappings":"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"}